---
layout: post
title:  Installing Kubernetes on AWS with kops
date:   2017-01-04T11:40:00+8:00
---

Installing Kubernetes could be a tedious and error-prone process. Intead of setting up every thing in the hard way, you might want to use [kops](https://github.com/kubernetes/kops) to facilate the installation if you are planning to build your Kubernetes cluster on **AWS**.

Just follow most of instructions on the pages [Installing Kubernetes on AWS with kops](http://kubernetes.io/docs/getting-started-guides/kops/) and [aws.md](https://github.com/kubernetes/kops/blob/master/docs/aws.md) to install k8s then you should good to go.

Here are some of my suggestions on the installation.

### Try unreleasd version of kops

If you encounter issues of kops, or you want to setup latest release of kubernetes (becasue the development timeline of kops is usally fall behind kubernetes), you can install the unstable version (HEAD) of kops by homebrew on you Mac. 

```bash
$ brew update && brew install --HEAD kops
```

Please refer to [README](https://github.com/kubernetes/kops) for other ways to install kops. 

### Use the latest release of kubectl

If you don't have specific requirement sticking to the older version of kubernetes, it's usually a better idea to use the latest one since it's more stable and has more features.

Similarily, you can install kubectl via homebrew.

```bash
$ brew update && brew install kubectl
```

### Update your nameserver

Because most of kops operations do DNS lookup for NS records for you domain, if it cannot get the informaiton, it show an error like this

```
error doing DNS lookup for NS records for "dev.example.com": lookup dev.example.com on 192.168.0.1:53: no such host
```

On my mac, I tried to update the nameserver list in `/etc/resolv.conf` to solve the issue.

```
#
# Mac OS X Notice
#
# This file is not used by the host name and address resolution
# or the DNS query routing mechanisms used by most processes on
# this Mac OS X system.
#
# This file is automatically generated.
#
search dev.example.com
# use Google's DNS server instead
nameserver 8.8.8.8
nameserver 8.8.4.4
nameserver 192.168.0.1
```

### Change to the custom image to create instances

By default, Kops use debain AMI to spin up nodes. If you would like to change to a custom image (AMI), just edit the configuration of `nodes` **instance group** before kops actually creates the cluster.

```yaml
# $ kops edit ig --name=$CLUSTER_NAME nodes

apiVersion: kops/v1alpha2
kind: InstanceGroup
metadata:
  creationTimestamp: "2017-01-04T16:27:43Z"
  name: nodes
spec:
  associatePublicIp: true
  image: ${IMAGE_NAME}
  machineType: t2.medium
  maxSize: 2
  minSize: 2
  role: Node
  subnets:
  - ap-northeast-1a
```

Type the command `aws ec2 describe-images --image-id ami-XXXXX` To find out the image name.

[images.md](https://github.com/kubernetes/kops/blob/master/docs/images.md) has more information about the configurations of applying custom images.

Note that you can always update the spec of you instance group after the creation of the cluster.

### Verify the installation

![]({{site.baseurl}}/images/kops-route53.png)
![]({{site.baseurl}}/images/kops-s3.png)
![]({{site.baseurl}}/images/kops-auto-scaling-group.png)
![]({{site.baseurl}}/images/kops-ec2-instance.png)

